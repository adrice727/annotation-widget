<!DOCTYPE html>
<html lang="en" ng-app="demo">
<head>
<meta http-equiv="Content-type" content="text/html; charset=utf-8">
<title>OpenTok Annotations Demo</title>

<script src='http://static.opentok.com/webrtc/v2.2/js/opentok.min.js'></script>
<script src="//static.opentok.com/webrtc/v2.2/js/TB.js" type="text/javascript" charset="utf-8"></script>
<script src="../opentok-annotations.js" type="text/javascript" charset="utf-8"></script>
<link rel="stylesheet" href="../opentok-annotations.css" type="text/css" media="screen" charset="utf-8">

<script type="text/javascript" charset="utf-8">

    // *** Fill the following variables using your own Project info from the Dashboard  ***
    // ***                  (https://dashboard.tokbox.com/projects)                     ***

    var apiKey = '44631542';    // Replace with your own API key.
    var sessionId = ''; // Replace with your generated Session ID.
    var token = '';     // Replace with your generated Token (use Project Tools or from a server-side library)

    var session;
    var publisher;
    var subscribers = {};
    var toolbar;

    // Un-comment either of the following to set automatic logging and exception handling.
    // See the exceptionHandler() method below.
    // TB.setLogLevel(TB.DEBUG);
    // TB.addEventListener('exception', exceptionHandler);

    session = TB.initSession(sessionId);	// Initialize session

    var palette = [
        "#1abc9c",
        "#2ecc71",
        "#3498db",
        "#9b59b6",
        "#34495e",
        "#16a085",
        "#27ae60",
        "#2980b9",
        "#8e44ad",
        "#2c3e50",
        "#f1c40f",
        "#e67e22",
        "#e74c3c",
        "#ecf0f1",
        "#95a5a6",
        "#f39c12",
        "#d35400",
        "#c0392b",
        "#bdc3c7",
        "#7f8c8d"
    ];

    // Add event listeners to the session
    session.addEventListener('sessionConnected', sessionConnectedHandler);
    session.addEventListener('sessionDisconnected', sessionDisconnectedHandler);
    session.addEventListener('connectionCreated', connectionCreatedHandler);
    session.addEventListener('connectionDestroyed', connectionDestroyedHandler);
    session.addEventListener('streamCreated', streamCreatedHandler);
    session.addEventListener('streamDestroyed', streamDestroyedHandler);
    session.addEventListener('signal', signalHandler);

    //--------------------------------------
    //  LINK CLICK HANDLERS
    //--------------------------------------

    function connect() {
        session.connect(apiKey, token);
    }

    function disconnect() {
        // TODO Handle removing the annotation toolbar and all canvases

        session.disconnect();
        hide('disconnectLink');
        hide('publishLink');
        hide('unpublishLink');
    }

    // Called when user wants to start publishing to the session
    function startPublishing() {
        if (!publisher) {
            var parentDiv = document.getElementById('myCamera');
            var publisherDiv = document.createElement('div'); // Create a div for the publisher to replace
            var publisherProperties = {};
            publisherProperties.name = 'A web-based OpenTok client';
            publisherDiv.setAttribute('id', 'opentok_publisher');
            parentDiv.appendChild(publisherDiv);
            publisher = OT.initPublisher(publisherDiv.id, publisherProperties);
            session.publish(publisher, function (error) {
                if (error) {
                    console.log('The publisher failed to connect.');
                }
            });

            // Initialize a toolbar for controlling annotation canvases
            toolbar = new OT.Annotations.Toolbar({
                session: session,
                container: document.getElementById('toolbar'),
                colors: palette
            });

            var canvas = new OT.Annotations({
                session:  publisher.session,
                container: parentDiv
            });
            toolbar.addCanvas(canvas);

            show('unpublishLink');
            hide('publishLink');
        }
    }

    function stopPublishing() {
        // Clean up toolbar and canvas elements
        toolbar.removeCanvas(publisher.session.connection.connectionId);
        toolbar.remove();

        if (publisher) {
            session.unpublish(publisher);
        }
        publisher = null;

        show('publishLink');
        hide('unpublishLink');
    }

    //--------------------------------------
    //  OPENTOK EVENT HANDLERS
    //--------------------------------------

    function sessionConnectedHandler(event) {
        // Subscribe to all streams currently in the Session
        for (var i = 0; i < event.streams.length; i++) {
            addStream(event.streams[i]);
        }
        show('disconnectLink');
        show('publishLink');
        hide('connectLink');
    }

    // FIXME This belongs in the annotation js file
    function captureScreenshot() {
        publisher.getImageData();
    }

    function streamCreatedHandler(event) {
        // Subscribe to the newly created streams
        for (var i = 0; i < event.streams.length; i++) {
            TB.log('streamCreated - connectionId: ' + event.streams[i].connection.connectionId);
            TB.log('streamCreated - connectionData: ' + event.streams[i].connection.data);
            addStream(event.streams[i]);
        }
    }

    function streamDestroyedHandler(event) {
        // This signals that a stream was destroyed. Any Subscribers will automatically be removed.
        // This default behaviour can be prevented using event.preventDefault()
    }

    function sessionDisconnectedHandler(event) {
        // This signals that the user was disconnected from the Session. Any subscribers and publishers
        // will automatically be removed. This default behaviour can be prevented using event.preventDefault()
        publisher = null;

        show('connectLink');
        hide('disconnectLink');
        hide('publishLink');
        hide('unpublishLink');
    }

    function connectionDestroyedHandler(event) {
        // This signals that connections were destroyed
    }

    function connectionCreatedHandler(event) {
        // This signals new connections have been created.
    }

    function signalHandler(event) {
//			var signalsDiv = document.getElementById("signals");
//			var messageP = document.createElement("p");
//			messageP.innerHTML = event.data;
//			signalsDiv.appendChild(messageP);

        console.log(event.data)
    }

    /*
     If you un-comment the call to TB.addEventListener('exception', exceptionHandler) above, OpenTok calls the
     exceptionHandler() method when exception events occur. You can modify this method to further process exception events.
     If you un-comment the call to TB.setLogLevel(), above, OpenTok automatically displays exception event messages.
     */
    function exceptionHandler(event) {
        alert('Exception: ' + event.code + '::' + event.message);
    }

    //--------------------------------------
    //  HELPER METHODS
    //--------------------------------------

    function addStream(stream) {
        // Check if this is the stream that I am publishing, and if so do not publish.
        if (stream.connection.connectionId == session.connection.connectionId) {
            return;
        }
        var subscriberDiv = document.createElement('div'); // Create a div for the subscriber to replace
        subscriberDiv.setAttribute('id', stream.streamId); // Give the replacement div the id of the stream as its id.
        document.getElementById('subscribers').appendChild(subscriberDiv);
        subscribers[stream.streamId] = session.subscribe(stream, subscriberDiv.id);
    }

    function show(id) {
        document.getElementById(id).style.display = 'block';
    }

    function hide(id) {
        document.getElementById(id).style.display = 'none';
    }
</script>

<style type="text/css" media="screen">
    body {
        margin: 0;
        padding: 0;
    }

    #opentok_publisher, .publisherContainer {
        display: block;
        width: 100% !important;
        height: 100% !important;
        background-color: transparent;
        position: absolute;
        left: 0;
        right: 0;
    }
</style>
</head>
<body ng-controller="DemoCtrl">
<div id="links">
    <input type="button" value="Connect" id="connectLink" onClick="javascript:connect()"/>
    <input type="button" value="Disconnect" id="disconnectLink" onClick="javascript:disconnect()" style="display:none"/>
    <input type="button" value="Publish" id="publishLink" onClick="javascript:startPublishing()" style="display:none"/>
    <input type="button" value="Unpublish" id="unpublishLink" onClick="javascript:stopPublishing()"
           style="display:none"/>
</div>
<div id="myCamera" class="publisherContainer"></div>
<div id="subscribers"></div>
<div id="toolbar" style="height: 50px"></div>
</body>
</html>
